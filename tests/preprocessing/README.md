# Preprocessing テストスイート

このディレクトリには、データ前処理モジュール（`src.preprocessing`）のテストが含まれています。

## テスト対象モジュール

- `src.preprocessing.review_comment_processor` - レビューコメントの前処理とキーワード抽出

## ファイル構成

```
tests/preprocessing/
├── __init__.py                      # パッケージ初期化
├── test_review_comment_processor.py # レビューコメント処理のテスト
└── README.md                       # このファイル
```

## テスト実行方法

### 全テスト実行
```bash
pytest tests/preprocessing/ -v
```

### 個別テストファイル実行
```bash
pytest tests/preprocessing/test_review_comment_processor.py -v
```

### カバレッジ付き実行
```bash
pytest tests/preprocessing/ --cov=src.preprocessing --cov-report=html
```

## テストファイル詳細

### `test_review_comment_processor.py`
レビューコメント前処理機能の包括的なテスト（27テストケース）

#### TestGenerateNgrams (7テスト)
N-gram生成機能のテスト：
- ✅ **基本的なunigram生成**: 単語リストからの1-gram抽出
- ✅ **基本的なbigram生成**: 2つの単語の組み合わせ抽出
- ✅ **混合N-gram生成**: 1-gramと2-gramの同時生成
- ✅ **空の単語リスト**: エッジケース処理
- ✅ **単一単語**: 1つの単語のみの場合
- ✅ **N > 単語数**: N-gramのNが単語数より大きい場合
- ✅ **trigram生成**: 3つの単語の組み合わせ抽出

#### TestLoadBotNames (6テスト)
設定ファイルからのボット名読み込みテスト：
- ✅ **有効な設定読み込み**: 正常なINIファイルからの読み込み
- ✅ **空白文字処理**: ボット名の前後空白除去
- ✅ **ファイル不存在**: 存在しないファイルのエラーハンドリング
- ✅ **セクション不存在**: organizationセクションが無い場合
- ✅ **キー不存在**: botsキーが無い場合
- ✅ **空のbots値**: 空文字列の処理

#### TestLoadReviewLabels (4テスト)
JSONからのレビューラベル読み込みテスト：
- ✅ **有効なラベル読み込み**: 正常なJSONファイルからの読み込み
- ✅ **ファイル不存在**: 存在しないファイルのエラーハンドリング
- ✅ **無効なJSON**: 構文エラーのあるJSONの処理
- ✅ **空のラベル**: 空のラベルデータの処理

#### TestSummarizeKeywordsByInclusion (6テスト)
キーワード冗長性除去機能のテスト：
- ✅ **基本的な包含除去**: "good" ⊃ "looks good" の関係処理
- ✅ **包含関係なし**: 独立したキーワードの保持
- ✅ **空のキーワード**: 空リストの処理
- ✅ **部分包含**: 一部に包含関係がある場合
- ✅ **同一キーワード**: 重複キーワードの除去
- ✅ **複雑な包含**: 多重包含関係の処理

#### TestExtractAndSaveReviewKeywords (4テスト)
メイン機能の統合テスト：
- ✅ **基本的なキーワード抽出**: 完全なワークフローテスト
- ✅ **ボットフィルタリング**: ボットコメントの除外
- ✅ **無効なCSVカラム**: 不正なファイル形式のエラーハンドリング
- ✅ **checklistファイル不存在**: 入力ファイルのエラーハンドリング

## テスト内容

### 機能テスト
- ✅ N-gram生成アルゴリズム
- ✅ 設定ファイル解析
- ✅ JSONデータ読み込み
- ✅ キーワード冗長性除去
- ✅ レビューコメント前処理

### エラーハンドリングテスト
- ✅ ファイル不存在の処理
- ✅ 不正なファイル形式の処理
- ✅ 空データの処理
- ✅ 無効な設定の処理

### エッジケーステスト
- ✅ 空のデータセット
- ✅ 単一要素データ
- ✅ 異常に長い/短いデータ
- ✅ 特殊文字を含むデータ

### データ品質テスト
- ✅ 出力形式の検証
- ✅ データ型の一貫性
- ✅ 重複除去の確認
- ✅ フィルタリング精度

## 使用技術とライブラリ

### テストフレームワーク
- **unittest**: Python標準のテストフレームワーク
- **pytest**: より高機能なテスト実行
- **mock**: 外部依存関係のモック化

### データ処理
- **pandas**: CSVデータの処理
- **json**: JSONデータの読み書き
- **configparser**: INI設定ファイルの解析
- **pathlib**: ファイルパス操作

### テストユーティリティ
- **tempfile**: 一時ファイルの作成
- **numpy**: 数値データの扱い
- **unittest.mock**: 関数・モジュールのモック

## モック使用について

テストでは以下をモック化：
- **ファイルシステム**: 一時ファイルでの安全なテスト
- **設定ファイル**: テスト用の独立した設定
- **外部定数**: `LABELLED_CHANGE_COUNT`などの依存関係
- **ログ出力**: テスト実行時のログ制御

## テストデータ

### 使用するサンプルデータ
- **CSVファイル**: checklist.csvの模擬データ
- **INI設定**: gerrymanderconfig.iniの模擬設定
- **JSONラベル**: review_label.jsonの模擬ラベル
- **コメントデータ**: 実際のレビューコメントパターン

### データパターン
- 修正要求コメント (修正要求=1)
- 修正確認コメント (修正確認=1)
- ボットコメント (自動生成)
- 一般コメント (ラベルなし)

## 継続的改善

### 新機能追加時のガイドライン
1. **テスト駆動開発**: 機能実装前にテスト作成
2. **エッジケース考慮**: 異常系・境界値テスト
3. **パフォーマンス**: 大量データでの動作確認
4. **ドキュメント**: テスト内容の説明更新

### 品質保証
- **コードカバレッジ**: 90%以上を目標
- **実行時間**: 全テスト30秒以内
- **メモリ使用量**: 適切なリソース管理
- **再現性**: 同じ結果の一貫した出力

## 関連ドキュメント

- [src/preprocessing/README.md](../../src/preprocessing/README.md) - 実装詳細
- [tests/README.md](../README.md) - テスト全体の概要
- [data/processed/](../../data/processed/) - 処理済みデータの例
